# Self-Blind-VSR é—®é¢˜è§£å†³è®°å½•

æœ¬æ–‡æ¡£è®°å½•äº†åœ¨ä½¿ç”¨ Self-Blind-VSRï¼ˆåŒ…æ‹¬ Jittor ç‰ˆæœ¬å’Œ PyTorch ç‰ˆæœ¬ï¼‰è¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

## ç›®å½•

### Jittor ç‰ˆæœ¬é—®é¢˜

1. [æ¨¡å‹å¯¼å…¥é—®é¢˜](#1-æ¨¡å‹å¯¼å…¥é—®é¢˜)
2. [æ¨¡å‹è·¯å¾„é—®é¢˜](#2-æ¨¡å‹è·¯å¾„é—®é¢˜)
3. [API å…¼å®¹æ€§é—®é¢˜](#3-api-å…¼å®¹æ€§é—®é¢˜)
4. [Correlation å‡½æ•°å®ç°é—®é¢˜](#4-correlation-å‡½æ•°å®ç°é—®é¢˜)
5. [æ¨ç†å¡ä½é—®é¢˜](#5-æ¨ç†å¡ä½é—®é¢˜)
6. [Tensor è½¬æ¢é—®é¢˜](#6-tensor-è½¬æ¢é—®é¢˜)
7. [è¿›åº¦æ¡æ˜¾ç¤ºé—®é¢˜](#7-è¿›åº¦æ¡æ˜¾ç¤ºé—®é¢˜)
8. [Jittor Windows ç¼–è¯‘é”™è¯¯é—®é¢˜](#8-jittor-windows-ç¼–è¯‘é”™è¯¯é—®é¢˜)

### PyTorch ç‰ˆæœ¬é—®é¢˜

9. [CUDA Correlation ç¼–è¯‘å¤±è´¥é—®é¢˜](#9-cuda-correlation-ç¼–è¯‘å¤±è´¥é—®é¢˜)
10. [NumPy å…¼å®¹æ€§é—®é¢˜](#10-numpy-å…¼å®¹æ€§é—®é¢˜)

### Jittor è®­ç»ƒé—®é¢˜

11. [GPU å†…å­˜æº¢å‡ºå’Œ API å…¼å®¹æ€§é—®é¢˜](#11-gpu-å†…å­˜æº¢å‡ºå’Œ-api-å…¼å®¹æ€§é—®é¢˜)

---

## PyTorch ç‰ˆæœ¬é—®é¢˜è®°å½•

## 9. CUDA Correlation ç¼–è¯‘å¤±è´¥é—®é¢˜

### é—®é¢˜æè¿°

```
CUDA correlation compilation failed, using PyTorch fallback: Catastrophic error: cannot open source file "C:\Users\å§£æ¶˜æ¿ ç©ƒAppData\Local\Temp\tmpv50vh5ys\3188a8ed0464bbfe44e1e6833dfd133720f8dc50.cubin.cu"

1 catastrophic error detected in the compilation of "C:\Users\æ¯›å¥•å©·\AppData\Local\Temp\tmpv50vh5ys\3188a8ed0464bbfe44e1e6833dfd133720f8dc50.cubin.cu".
Compilation terminated.
```

### é”™è¯¯åŸå› 

1. **ä¸­æ–‡è·¯å¾„é—®é¢˜**ï¼šWindows ç³»ç»Ÿç”¨æˆ·ååŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå¯¼è‡´ä¸´æ—¶æ–‡ä»¶è·¯å¾„åŒ…å«ä¸­æ–‡
2. **CuPy ç¼–è¯‘å¤±è´¥**ï¼šCuPy åœ¨ç¼–è¯‘ CUDA å†…æ ¸æ—¶æ— æ³•å¤„ç†åŒ…å«ä¸­æ–‡å­—ç¬¦çš„è·¯å¾„
3. **ä¸´æ—¶ç›®å½•è®¾ç½®**ï¼šç³»ç»Ÿé»˜è®¤ä½¿ç”¨ç”¨æˆ·ç›®å½•ä¸‹çš„ Temp æ–‡ä»¶å¤¹ä½œä¸ºä¸´æ—¶ç›®å½•

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

1. **è®¾ç½®ä¸´æ—¶ç›®å½•ç¯å¢ƒå˜é‡**ï¼š

    ```cmd
    set TEMP=D:\temp
    set TMP=D:\temp
    ```

2. **åˆ›å»ºä¸´æ—¶ç›®å½•**ï¼š

    ```cmd
    if not exist D:\temp mkdir D:\temp
    ```

3. **éªŒè¯è®¾ç½®**ï¼š

    ```cmd
    echo %TEMP%
    echo %TMP%
    ```

4. **é‡æ–°è¿è¡Œæ¨ç†**ï¼š
    ```cmd
    cd code
    python inference.py --quick_test Realistic_REDS4
    ```

#### æ–¹æ¡ˆäºŒï¼šä¿®æ”¹ä»£ç å¼ºåˆ¶ä½¿ç”¨ PyTorch å®ç°

å¦‚æœç¯å¢ƒå˜é‡è®¾ç½®æ— æ•ˆï¼Œå¯ä»¥ä¿®æ”¹ä»£ç ç›´æ¥ä½¿ç”¨ PyTorch fallbackï¼š

```python
def _check_cuda_availability():
    global _cuda_available
    if _cuda_available is None:
        # Force using PyTorch fallback to avoid CUDA compilation issues
        _cuda_available = False
        print("Using PyTorch correlation fallback (CUDA compilation disabled)")
    return _cuda_available
```

#### æ–¹æ¡ˆä¸‰ï¼šæ›´æ–°ç¯å¢ƒä¾èµ–

1. **æ›´æ–° CuPy ç‰ˆæœ¬**ï¼š

    ```bash
    pip install --upgrade cupy-cuda11x  # æ ¹æ®CUDAç‰ˆæœ¬é€‰æ‹©
    # æˆ–è€…
    pip install --upgrade cupy-cuda12x  # CUDA 12.xç‰ˆæœ¬
    ```

2. **æ£€æŸ¥ CUDA å·¥å…·é“¾**ï¼š

    ```bash
    nvcc --version  # ç¡®ä¿CUDAå¼€å‘å·¥å…·æ­£ç¡®å®‰è£…
    ```

3. **æ¸…ç†ç¼“å­˜**ï¼š
    ```bash
    # æ¸…ç†CuPyç¼“å­˜
    python -c "import cupy; cupy.clear_memory_pool()"
    # åˆ é™¤ä¸´æ—¶ç¼–è¯‘æ–‡ä»¶
    rmdir /s D:\temp\cupy_cache
    ```

#### æ–¹æ¡ˆå››ï¼šç³»ç»Ÿçº§ç¯å¢ƒå˜é‡è®¾ç½®

1. **é€šè¿‡ç³»ç»Ÿå±æ€§è®¾ç½®**ï¼š

    - å³é”®"æ­¤ç”µè„‘" â†’ å±æ€§ â†’ é«˜çº§ç³»ç»Ÿè®¾ç½® â†’ ç¯å¢ƒå˜é‡
    - åœ¨ç³»ç»Ÿå˜é‡ä¸­æ·»åŠ ï¼š
        - `TEMP = D:\temp`
        - `TMP = D:\temp`

2. **é‡å¯ç³»ç»Ÿæˆ–é‡æ–°æ‰“å¼€å‘½ä»¤è¡Œ**

### é—®é¢˜å½±å“

-   **åŠŸèƒ½å½±å“**ï¼šä¸å½±å“æ¨¡å‹æ¨ç†åŠŸèƒ½ï¼Œä¼šè‡ªåŠ¨å›é€€åˆ° PyTorch å®ç°
-   **æ€§èƒ½å½±å“**ï¼š
    -   CUDA å†…æ ¸å®ç°ï¼š~0.18s/å¸§ï¼ˆä¼˜åŒ–åï¼‰
    -   PyTorch fallbackï¼š~0.22s/å¸§ï¼ˆçº¦æ…¢ 20%ï¼‰
    -   å¯¹äºæ¨ç†ä»»åŠ¡ï¼Œå·®å¼‚é€šå¸¸ä¸æ˜æ˜¾
-   **ç¨³å®šæ€§**ï¼šPyTorch å®ç°æ›´ç¨³å®šï¼Œå…¼å®¹æ€§æ›´å¥½ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ

### è§£å†³éªŒè¯

æˆåŠŸè§£å†³åä¼šçœ‹åˆ°ï¼š

```
CUDA correlation implementation available
```

è€Œä¸æ˜¯ï¼š

```
CUDA correlation compilation failed, using PyTorch fallback
```

### æŠ€æœ¯ç»†èŠ‚

1. **ç›¸å…³æ–‡ä»¶åŠä½œç”¨**ï¼š

    - `code/model/correlation/correlation.py`ï¼šä¸»è¦çš„ correlation å®ç°ï¼ŒåŒ…å«è‡ªå®šä¹‰ CUDA å†…æ ¸
    - `code/model/correlation/correlation_pytorch.py`ï¼šPyTorch fallback å®ç°
    - `code/model/correlation/__init__.py`ï¼šæ¨¡å—åˆå§‹åŒ–ï¼Œå¯¼å…¥ç›¸å…³å‡½æ•°

2. **CUDA å†…æ ¸å®ç°**ï¼š

    - **kernel_Correlation_rearrange**ï¼šé‡æ–°æ’åˆ—è¾“å…¥æ•°æ®
    - **kernel_Correlation_updateOutput**ï¼šè®¡ç®— correlation è¾“å‡º
    - **kernel_Correlation_updateGradFirst/Second**ï¼šè®¡ç®—æ¢¯åº¦
    - ä½¿ç”¨ CuPy çš„ `RawKernel` æˆ– `compile_with_cache` è¿›è¡Œç¼–è¯‘

3. **ç¼–è¯‘è¿‡ç¨‹è¯¦è§£**ï¼š

    - `cupy_kernel()` å‡½æ•°ï¼šå¤„ç† CUDA å†…æ ¸ä»£ç æ¨¡æ¿ï¼Œæ›¿æ¢å°ºå¯¸å‚æ•°
    - `cupy_launch()` å‡½æ•°ï¼šç¼–è¯‘å¹¶ç¼“å­˜ CUDA å†…æ ¸ï¼Œæ”¯æŒå¤šç§ CuPy ç‰ˆæœ¬
    - ç¼–è¯‘ç»“æœç¼“å­˜åœ¨ `_kernel_cache` å­—å…¸ä¸­
    - ä¸´æ—¶æ–‡ä»¶ç”Ÿæˆåœ¨ç³»ç»Ÿ TEMP ç›®å½•ä¸­

4. **Fallback æœºåˆ¶**ï¼š

    - `_check_cuda_availability()` å‡½æ•°æµ‹è¯• CUDA ç¼–è¯‘å¯ç”¨æ€§
    - å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œ`FunctionCorrelation()` è‡ªåŠ¨åˆ‡æ¢åˆ° PyTorch å®ç°
    - PyTorch å®ç°ä½¿ç”¨çº¯ tensor æ“ä½œï¼Œè®¡ç®— 9Ã—9 ä½ç§»çª—å£çš„ correlation

5. **ç¯å¢ƒä¾èµ–**ï¼š
    - CUDA å·¥å…·é“¾ï¼ˆnvcc ç¼–è¯‘å™¨ï¼‰
    - CuPy åº“ï¼ˆ>=8.0 æ¨èï¼‰
    - æ”¯æŒä¸­æ–‡è·¯å¾„çš„ç¼–è¯‘å™¨
    - ä¸´æ—¶ç›®å½•çš„è¯»å†™æƒé™

### å®é™…è§£å†³ç»éªŒ

åœ¨æœ¬æ¬¡é—®é¢˜è§£å†³è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„å…·ä½“æ­¥éª¤ï¼š

1. **é—®é¢˜è¯Šæ–­**ï¼š

    ```bash
    # æ£€æŸ¥é”™è¯¯ä¿¡æ¯ä¸­çš„ä¸´æ—¶è·¯å¾„
    # å‘ç°è·¯å¾„åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼šC:\Users\æ¯›å¥•å©·\AppData\Local\Temp\
    ```

2. **ç¯å¢ƒå˜é‡è®¾ç½®**ï¼š

    ```bash
    set TEMP=D:\temp
    set TMP=D:\temp
    echo %TEMP%  # éªŒè¯è®¾ç½®æˆåŠŸ
    ```

3. **æ•ˆæœéªŒè¯**ï¼š

    - è®¾ç½®å‰ï¼šæ˜¾ç¤º `CUDA correlation compilation failed`
    - è®¾ç½®åï¼šæ˜¾ç¤º `CUDA correlation implementation available`

4. **æ€§èƒ½å¯¹æ¯”**ï¼š
    - æˆåŠŸå¯ç”¨ CUDA åŠ é€Ÿåï¼Œæ¨ç†é€Ÿåº¦æ˜æ˜¾æå‡
    - é¦–å¸§å¤„ç†æ—¶é—´ä» 4+ ç§’é™åˆ° 1.7 ç§’å·¦å³

### é¢„é˜²æªæ–½

1. **ç¯å¢ƒè®¾ç½®**ï¼šåœ¨é¡¹ç›®å¼€å§‹å‰è®¾ç½®å¥½ç¯å¢ƒå˜é‡
2. **è·¯å¾„è§„èŒƒ**ï¼šé¿å…åœ¨åŒ…å«ä¸­æ–‡å­—ç¬¦çš„è·¯å¾„ä¸‹è¿è¡Œæ·±åº¦å­¦ä¹ é¡¹ç›®
3. **æƒé™æ£€æŸ¥**ï¼šç¡®ä¿å¯¹ä¸´æ—¶ç›®å½•æœ‰è¯»å†™æƒé™
4. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šä½¿ç”¨ç»è¿‡æµ‹è¯•çš„ CuPy å’Œ CUDA ç‰ˆæœ¬ç»„åˆ

---

## 10. NumPy å…¼å®¹æ€§é—®é¢˜

### é—®é¢˜æè¿°

```
âŒ è®­ç»ƒå‡ºé”™: module 'numpy' has no attribute 'float'.
`np.float` was a deprecated alias for the builtin `float`. To avoid this error in existing code, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
The aliases was originally deprecated in NumPy 1.20; for more details and guidance see the original release note at:
    https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations

File "/root/Self-Blind-VSR/code/data/videodata_hrlr.py", line 152, in _load_file
    gts = np.array([imageio.imread(hr_name) for hr_name in f_gts], dtype=np.float)
                                                                         ^^^^^^^^
AttributeError: module 'numpy' has no attribute 'float'.
```

### é”™è¯¯åŸå› 

1. **NumPy ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜**ï¼šNumPy 1.20+ ç‰ˆæœ¬åºŸå¼ƒäº† `np.float` ç­‰ç±»å‹åˆ«å
2. **åºŸå¼ƒçš„ç±»å‹åˆ«å**ï¼š`np.float`ã€`np.int`ã€`np.bool`ã€`np.complex` ç­‰åœ¨æ–°ç‰ˆæœ¬ä¸­è¢«ç§»é™¤
3. **ä»£ç å†å²é—ç•™**ï¼šæ—§ä»£ç ä½¿ç”¨äº†è¿™äº›å·²åºŸå¼ƒçš„ç±»å‹åˆ«å

### è§£å†³æ–¹æ¡ˆ

#### ä¿®å¤ np.float ä½¿ç”¨

1. **videodata_hrlr.py** (ç¬¬ 82ã€83ã€151ã€152 è¡Œ)ï¼š

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
gts = np.array([imageio.imread(hr_name) for hr_name in images_gt[idx]], dtype=np.float)
inputs = np.array([imageio.imread(lr_name) for lr_name in images_input[idx]], dtype=np.float)
gts = np.array([imageio.imread(hr_name) for hr_name in f_gts], dtype=np.float)
inputs = np.array([imageio.imread(lr_name) for lr_name in f_inputs], dtype=np.float)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
gts = np.array([imageio.imread(hr_name) for hr_name in images_gt[idx]], dtype=np.float32)
inputs = np.array([imageio.imread(lr_name) for lr_name in images_input[idx]], dtype=np.float32)
gts = np.array([imageio.imread(hr_name) for hr_name in f_gts], dtype=np.float32)
inputs = np.array([imageio.imread(lr_name) for lr_name in f_inputs], dtype=np.float32)
```

2. **videodata_online_realistic.py** (ç¬¬ 76 è¡Œ)ï¼š

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
gts = np.array([imageio.imread(hr_name) for hr_name in images_gt[idx]], dtype=np.float)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
gts = np.array([imageio.imread(hr_name) for hr_name in images_gt[idx]], dtype=np.float32)
```

### å…¨é¢å…¼å®¹æ€§æ£€æŸ¥ç»“æœ

ç»è¿‡å…¨é¢ä»£ç æ£€æŸ¥ï¼Œå‘ç°å’Œä¿®å¤çš„é—®é¢˜ï¼š

#### âœ… å·²ä¿®å¤çš„æ–‡ä»¶

1. **PyTorch ç‰ˆæœ¬**ï¼š

    - `code/data/videodata_hrlr.py` - 4 å¤„ `np.float` ä½¿ç”¨
    - `code/data/videodata_online_realistic.py` - 1 å¤„ `np.float` ä½¿ç”¨

2. **Jittor ç‰ˆæœ¬**ï¼š
    - æ£€æŸ¥ç»“æœï¼š**æ— å…¼å®¹æ€§é—®é¢˜** âœ…
    - æ‰€æœ‰ NumPy ä½¿ç”¨å‡ä¸ºæ­£ç¡®çš„ `np.float32` æˆ– `np.float64`

#### âœ… æ£€æŸ¥çš„å…¶ä»–åºŸå¼ƒç±»å‹

å…¨é¢æœç´¢ç»“æœæ˜¾ç¤ºï¼Œé¡¹ç›®ä¸­**æœªä½¿ç”¨**ä»¥ä¸‹åºŸå¼ƒç±»å‹ï¼š

-   `np.int` âœ… æœªå‘ç°ä½¿ç”¨
-   `np.bool` âœ… æœªå‘ç°ä½¿ç”¨
-   `np.complex` âœ… æœªå‘ç°ä½¿ç”¨
-   `astype(np.float)` âœ… æœªå‘ç°ä½¿ç”¨

### æ•°æ®ç±»å‹é€‰æ‹©è¯´æ˜

**æ¨èçš„æ›¿ä»£æ–¹æ¡ˆ**ï¼š

| åºŸå¼ƒç±»å‹     | æ¨èæ›¿ä»£             | ç”¨é€”è¯´æ˜               |
| ------------ | -------------------- | ---------------------- |
| `np.float`   | `np.float32`         | ä¸€èˆ¬æµ®ç‚¹æ•°ï¼ˆèŠ‚çœå†…å­˜ï¼‰ |
| `np.float`   | `np.float64`         | é«˜ç²¾åº¦æµ®ç‚¹æ•°           |
| `np.int`     | `np.int32`           | ä¸€èˆ¬æ•´æ•°               |
| `np.int`     | `np.int64`           | å¤§æ•´æ•°                 |
| `np.bool`    | `bool` æˆ– `np.bool_` | å¸ƒå°”å€¼                 |
| `np.complex` | `np.complex64`       | å¤æ•°                   |

**æœ¬é¡¹ç›®ä¸­çš„é€‰æ‹©**ï¼š

-   ä½¿ç”¨ `np.float32`ï¼šé€‚åˆæ·±åº¦å­¦ä¹ ï¼ŒèŠ‚çœæ˜¾å­˜
-   é¿å… `np.float64`ï¼šé™¤ééœ€è¦é«˜ç²¾åº¦è®¡ç®—

### ç‰ˆæœ¬å…¼å®¹æ€§ä¿¡æ¯

**å½±å“ç‰ˆæœ¬**ï¼š

-   NumPy 1.20+ï¼šå¼€å§‹åºŸå¼ƒè­¦å‘Š
-   NumPy 1.24+ï¼šå®Œå…¨ç§»é™¤ï¼Œä¼šæŠ¥é”™

**è§£å†³æ—¶æœº**ï¼š

-   **ç«‹å³ä¿®å¤**ï¼šé¿å…åœ¨æ–°ç¯å¢ƒä¸­è¿è¡Œå¤±è´¥
-   **å‘å‰å…¼å®¹**ï¼šç¡®ä¿ä»£ç åœ¨æ–°ç‰ˆ NumPy ä¸­æ­£å¸¸è¿è¡Œ

### é¢„é˜²æªæ–½

1. **ä»£ç å®¡æŸ¥**ï¼šæ–°ä»£ç é¿å…ä½¿ç”¨åºŸå¼ƒçš„ NumPy ç±»å‹åˆ«å
2. **ä¾èµ–ç®¡ç†**ï¼šåœ¨ requirements.txt ä¸­æŒ‡å®šå…¼å®¹çš„ NumPy ç‰ˆæœ¬èŒƒå›´
3. **è‡ªåŠ¨åŒ–æ£€æŸ¥**ï¼šä½¿ç”¨ linting å·¥å…·æ£€æµ‹åºŸå¼ƒ API ä½¿ç”¨
4. **æµ‹è¯•è¦†ç›–**ï¼šåœ¨ä¸åŒ NumPy ç‰ˆæœ¬ä¸‹æµ‹è¯•ä»£ç å…¼å®¹æ€§

### æŠ€æœ¯ç»†èŠ‚

**NumPy ç±»å‹ç³»ç»Ÿå˜åŒ–**ï¼š

```python
# æ—§å¼å†™æ³•ï¼ˆå·²åºŸå¼ƒï¼‰
np.float    # âŒ åœ¨NumPy 1.24+ä¸­ä¼šæŠ¥é”™
np.int      # âŒ åœ¨NumPy 1.24+ä¸­ä¼šæŠ¥é”™

# æ–°å¼å†™æ³•ï¼ˆæ¨èï¼‰
np.float32  # âœ… æ˜ç¡®æŒ‡å®šç²¾åº¦
np.float64  # âœ… æ˜ç¡®æŒ‡å®šç²¾åº¦
float       # âœ… Pythonå†…ç½®ç±»å‹
np.int32    # âœ… æ˜ç¡®æŒ‡å®šç²¾åº¦
np.int64    # âœ… æ˜ç¡®æŒ‡å®šç²¾åº¦
int         # âœ… Pythonå†…ç½®ç±»å‹
```

**ä¿®å¤éªŒè¯**ï¼š

```bash
# éªŒè¯ä¿®å¤æ•ˆæœ
python -c "import numpy as np; print('NumPy version:', np.__version__)"
python main.py --template Self_Blind_VSR_Realistic
# åº”è¯¥ä¸å†å‡ºç° np.float ç›¸å…³é”™è¯¯
```

### å®é™…å½±å“

**ä¿®å¤å‰**ï¼š

-   è®­ç»ƒåœ¨éªŒè¯é˜¶æ®µå¤±è´¥ï¼Œå‡ºç° `AttributeError: module 'numpy' has no attribute 'float'`
-   æ— æ³•å®Œæˆå®Œæ•´çš„è®­ç»ƒ-éªŒè¯å¾ªç¯

**ä¿®å¤å**ï¼š

-   è®­ç»ƒå’ŒéªŒè¯æ­£å¸¸è¿›è¡Œ
-   ä¸æ‰€æœ‰ NumPy ç‰ˆæœ¬(1.20+)å…¼å®¹
-   ä»£ç æ›´åŠ å¥å£®å’Œé¢å‘æœªæ¥

### è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å‘åå…¼å®¹æ€§é—®é¢˜ï¼ŒNumPy ä¸ºäº† API æ¸…ç†ç§»é™¤äº†æ¨¡ç³Šçš„ç±»å‹åˆ«åã€‚ä¿®å¤åçš„ä»£ç ä¸ä»…è§£å†³äº†é”™è¯¯ï¼Œè¿˜æé«˜äº†ä»£ç çš„å¯è¯»æ€§ï¼ˆæ˜ç¡®æŒ‡å®šäº†æ•°æ®ç²¾åº¦ï¼‰å’Œå…¼å®¹æ€§ã€‚å»ºè®®æ‰€æœ‰æ·±åº¦å­¦ä¹ é¡¹ç›®éƒ½è¿›è¡Œç±»ä¼¼çš„å…¼å®¹æ€§æ£€æŸ¥å’Œä¿®å¤ã€‚

---

## Jittor ç‰ˆæœ¬é—®é¢˜è®°å½•

## 1. æ¨¡å‹å¯¼å…¥é—®é¢˜

### é—®é¢˜æè¿°

```
æ— æ³•è§£æå¯¼å…¥"model.recons"
```

### é”™è¯¯åŸå› 

å¯¼å…¥è·¯å¾„ä¸å®é™…æ¨¡å‹æ–‡ä»¶åä¸åŒ¹é…ã€‚

### è§£å†³æ–¹æ¡ˆ

å°†å¯¼å…¥è¯­å¥ä»ï¼š

```python
from model.recons import PWC_Recons
```

ä¿®æ”¹ä¸ºï¼š

```python
from model.pwc_recons import PWC_Recons
```

### è¯´æ˜

ç¡®ä¿å¯¼å…¥è·¯å¾„ä¸å®é™…åˆ›å»ºçš„æ¨¡å‹æ–‡ä»¶åç§°ä¸€è‡´ã€‚

---

## 2. æ¨¡å‹è·¯å¾„é—®é¢˜

### é—®é¢˜æè¿°

```
æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶
```

### é”™è¯¯åŸå› 

é»˜è®¤æ¨¡å‹è·¯å¾„è®¾ç½®ä¸æ­£ç¡®ï¼Œæ— æ³•æ‰¾åˆ°é¢„è®­ç»ƒæ¨¡å‹æ–‡ä»¶ã€‚

### è§£å†³æ–¹æ¡ˆ

1. ç¡®è®¤æ¨¡å‹æ–‡ä»¶å­˜åœ¨äºæ­£ç¡®ä½ç½®ï¼š`../pretrain_models/self_blind_vsr_gaussian_numpy.pkl`
2. åœ¨ä»£ç ä¸­æ·»åŠ æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼š

```python
if not os.path.exists(self.model_path):
    raise FileNotFoundError(f'æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {self.model_path}')
```

### è¯´æ˜

é¢„è®­ç»ƒæ¨¡å‹åº”æ”¾åœ¨`pretrain_models`æ–‡ä»¶å¤¹ä¸­ï¼Œæ”¯æŒ`.pkl`å’Œ`.pt`æ ¼å¼ã€‚

---

## 3. API å…¼å®¹æ€§é—®é¢˜

### é—®é¢˜æè¿°

```
jittor.nn.functionalæ¨¡å—ä¸å­˜åœ¨
nn.interpolateå’Œnn.leaky_reluå‚æ•°é”™è¯¯
```

### é”™è¯¯åŸå› 

Jittor ä¸ PyTorch çš„ API å­˜åœ¨å·®å¼‚ã€‚

### è§£å†³æ–¹æ¡ˆ

1. **nn.functional é—®é¢˜**ï¼š
    - Jittor ä¸­ç›´æ¥ä½¿ç”¨`jt.nn`ï¼Œæ— éœ€`functional`å­æ¨¡å—
2. **nn.interpolate å‚æ•°é—®é¢˜**ï¼š

    ```python
    # é”™è¯¯å†™æ³•
    nn.interpolate(input=x, scale_factor=2)
    # æ­£ç¡®å†™æ³•
    nn.interpolate(x, scale_factor=2)
    ```

3. **nn.leaky_relu å‚æ•°é—®é¢˜**ï¼š
    ```python
    # é”™è¯¯å†™æ³•
    nn.leaky_relu(x, negative_slope=0.1)
    # æ­£ç¡®å†™æ³•
    nn.leaky_relu(x, scale=0.1)
    ```

### è¯´æ˜

ç§»æ¤ PyTorch ä»£ç åˆ° Jittor æ—¶éœ€è¦æ³¨æ„ API å·®å¼‚ï¼Œç‰¹åˆ«æ˜¯å‡½æ•°å‚æ•°åç§°ã€‚

---

## 4. Correlation å‡½æ•°å®ç°é—®é¢˜

### é—®é¢˜æè¿°

```
é€šé“æ•°ä¸åŒ¹é…é”™è¯¯
expected 81 channels but got xxx
```

### é”™è¯¯åŸå› 

åŸå§‹ correlation å‡½æ•°è¿”å›çš„å¼ é‡å½¢çŠ¶ä¸æ­£ç¡®ã€‚

### è§£å†³æ–¹æ¡ˆ

é‡æ–°å®ç° correlation å‡½æ•°ï¼Œç¡®ä¿è¿”å›æ­£ç¡®çš„å½¢çŠ¶`[B, 81, H, W]`ï¼š

```python
def correlation_jittor(input1, input2, kernel_size=1, max_displacement=4, stride1=1, stride2=1, pad_size=4):
    # å®ç°9x9ä½ç§»çª—å£çš„correlationè®¡ç®—
    # è¿”å›81ä¸ªé€šé“çš„correlation map
```

### è¯´æ˜

Correlation æ“ä½œç”¨äºè®¡ç®—å…‰æµï¼Œéœ€è¦è¿”å›æ‰€æœ‰å¯èƒ½ä½ç§»çš„ correlation å€¼ã€‚

---

## 5. æ¨ç†å¡ä½é—®é¢˜

### é—®é¢˜æè¿°

```
å¤„ç†è§†é¢‘: 000:   0%|                       | 0/384 [00:00<?, ?å¸§/s]
ä¸€ç›´ä¸åŠ¨
```

### é”™è¯¯åŸå› 

1. GPU è®¾ç½®ä¸æ˜ç¡®
2. æ¨¡å‹æœªé¢„çƒ­
3. ç¼ºå°‘è¯¦ç»†çš„çŠ¶æ€è¾“å‡º

### è§£å†³æ–¹æ¡ˆ

1. **æ˜ç¡®è®¾ç½® GPU**ï¼š

    ```python
    jt.flags.use_cuda = 1 if jt.has_cuda else 0
    ```

2. **æ·»åŠ  GPU çŠ¶æ€è¾“å‡º**ï¼š

    ```python
    if jt.has_cuda and jt.flags.use_cuda:
        self.logger.write_log('ä½¿ç”¨GPUè¿›è¡Œæ¨ç†')
        self.logger.write_log(f'GPUè®¾å¤‡æ•°é‡: {jt.get_device_count()}')
    else:
        self.logger.write_log('ä½¿ç”¨CPUè¿›è¡Œæ¨ç†')
    ```

3. **æ¨¡å‹é¢„çƒ­**ï¼š

    ```python
    dummy_input = jt.randn(1, 5, 3, 64, 64)
    with jt.no_grad():
        _ = self.net({'x': dummy_input, 'mode': 'infer'})
    ```

4. **æ·»åŠ å¼‚å¸¸å¤„ç†**ï¼š
    ```python
    try:
        output_dict, _ = self.net({'x': in_tensor, 'mode': 'infer'})
        output = output_dict['recons']
    except Exception as e:
        self.logger.write_log(f'å‰å‘ä¼ æ’­é”™è¯¯: {e}')
        continue
    ```

### è¯´æ˜

æ¨ç†å¡ä½é€šå¸¸æ˜¯ç”±äº GPU è®¾ç½®é—®é¢˜æˆ–æ¨¡å‹åˆå§‹åŒ–é—®é¢˜å¯¼è‡´çš„ã€‚

---

## 6. Tensor è½¬æ¢é—®é¢˜

### é—®é¢˜æè¿°

```
AttributeError: 'numpy.ndarray' object has no attribute 'numpy'
```

### é”™è¯¯åŸå› 

åœ¨ Jittor ä¸­ï¼Œ`.data`å±æ€§å·²ç»è¿”å› numpy æ•°ç»„ï¼Œä¸éœ€è¦å†è°ƒç”¨`.numpy()`æ–¹æ³•ã€‚

### è§£å†³æ–¹æ¡ˆ

å°†ï¼š

```python
img = np.transpose(img.numpy(), (1, 2, 0)).astype(np.uint8)
```

ä¿®æ”¹ä¸ºï¼š

```python
img = np.transpose(img, (1, 2, 0)).astype(np.uint8)
```

### è¯´æ˜

Jittor å’Œ PyTorch åœ¨ tensor åˆ° numpy è½¬æ¢ä¸Šæœ‰æ‰€ä¸åŒã€‚

---

## 7. è¿›åº¦æ¡æ˜¾ç¤ºé—®é¢˜

### é—®é¢˜æè¿°

è¿›åº¦æ¡ä¸åœ¨åŸåœ°æ›´æ–°ï¼Œæ¯æ¬¡éƒ½æ–°å¼€ä¸€è¡Œæ˜¾ç¤ºã€‚

### é”™è¯¯åŸå› 

è¿›åº¦æ¡é…ç½®å‚æ•°å¯¼è‡´æ˜¾ç¤ºæ ¼å¼é—®é¢˜ã€‚

### è§£å†³æ–¹æ¡ˆ

1. **ä¿®å¤è¿›åº¦æ¡å‚æ•°**ï¼š

    ```python
    pbar = tqdm(total=total_sequences, desc="æ¨ç†è¿›åº¦", unit="å¸§",
               ncols=100, leave=True, dynamic_ncols=False)
    ```

2. **æˆ–è€…ç›´æ¥åˆ é™¤è¿›åº¦æ¡**ï¼ˆç”¨æˆ·æœ€ç»ˆé€‰æ‹©ï¼‰ï¼š
    - åˆ é™¤ tqdm å¯¼å…¥
    - åˆ é™¤æ‰€æœ‰è¿›åº¦æ¡ç›¸å…³ä»£ç 
    - ä½¿ç”¨æ—¥å¿—è¾“å‡ºæ›¿ä»£

### è¯´æ˜

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæœ€ç»ˆé€‰æ‹©äº†åˆ é™¤è¿›åº¦æ¡ï¼Œä½¿ç”¨æ›´ç®€æ´çš„æ—¥å¿—è¾“å‡ºæ–¹å¼ã€‚

---

## 8. Jittor Windows ç¼–è¯‘é”™è¯¯é—®é¢˜

### é—®é¢˜æè¿°

```
UnboundLocalError: local variable 'link' referenced before assignment
File "D:\anaconda3\envs\pytorch01\lib\site-packages\jittor\compiler.py", line 103, in compile
link = link + f' -Wl,--export-all-symbols,--out-implib,"{afile}" '
```

### é”™è¯¯åŸå› 

1. **Jittor ç‰ˆæœ¬ Bug**ï¼šJittor 1.3.9.x ç³»åˆ—åœ¨ Windows ç¯å¢ƒä¸‹å­˜åœ¨å·²çŸ¥çš„ç¼–è¯‘å™¨æ£€æµ‹ bug
    - ç‰¹åˆ«æ˜¯ 1.3.9.14 ç‰ˆæœ¬ï¼Œåœ¨ Windows ä¸‹æ™®éå‡ºç°æ­¤é—®é¢˜
    - è¿™æ˜¯æ¡†æ¶å±‚é¢çš„ç¼ºé™·ï¼Œä¸æ˜¯ç”¨æˆ·é…ç½®é—®é¢˜
2. **å˜é‡ä½œç”¨åŸŸé—®é¢˜**ï¼šåœ¨ `jittor/compiler.py` æ–‡ä»¶ä¸­ï¼Œ`link` å˜é‡åœ¨æŸäº›æ¡ä»¶åˆ†æ”¯ä¸‹æ²¡æœ‰è¢«åˆå§‹åŒ–å°±è¢«ä½¿ç”¨
3. **Windows ç¯å¢ƒç‰¹æ®Šæ€§**ï¼š
    - Jittor åœ¨ Windows ä¸‹é»˜è®¤å°è¯•ä½¿ç”¨ MSVC ç¼–è¯‘å™¨
    - å½“æ£€æµ‹åˆ° MinGW/g++ æ—¶ï¼Œä»£ç è·¯å¾„å‘ç”Ÿå˜åŒ–
    - æŸäº›æƒ…å†µä¸‹ `link` å˜é‡åœ¨ä½¿ç”¨å‰æœªè¢«æ­£ç¡®åˆå§‹åŒ–

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ Dockerï¼ˆå¼ºçƒˆæ¨èï¼‰

Docker æ–¹æ¡ˆå®Œå…¨é¿å¼€äº† Windows ç¼–è¯‘é—®é¢˜ï¼š

```bash
# æ‹‰å– Jittor å®˜æ–¹é•œåƒ
docker pull jittor/jittor

# è¿è¡Œæ¨ç†
docker run -it --rm -v "%cd%":/workspace jittor/jittor bash -c "
    cd /workspace/jittor_self_blind_vsr &&
    pip install opencv-python pillow tqdm scikit-image &&
    python inference.py --model_path ../pretrain_models/self_blind_vsr_gaussian.pt --input_dir ../dataset/input/000 --output_dir ./results_docker/gaussian_000
"
```

#### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ WSLï¼ˆLinux å­ç³»ç»Ÿï¼‰

```bash
# 1. å®‰è£… WSL
wsl --install

# 2. åœ¨ WSL ä¸­å®‰è£…ä¾èµ–
sudo apt update
sudo apt install python3 python3-pip build-essential libomp-dev

# 3. å®‰è£… Jittor
pip3 install jittor

# 4. è¿è¡Œæ¨ç†
export cc_path="g++"
python3 inference.py --model_path ../pretrain_models/self_blind_vsr_gaussian.pt --input_dir ../dataset/input/000 --output_dir ./results_wsl/gaussian_000
```

#### æ–¹æ¡ˆä¸‰ï¼šæ‰‹åŠ¨ä¿®å¤ Jittor æºç ï¼ˆå¼€å‘è€…é€‰é¡¹ï¼‰

1. **å®šä½æ–‡ä»¶**ï¼š

    ```bash
    # æ‰¾åˆ° Jittor å®‰è£…ä½ç½®
    python -c "import jittor; print(jittor.__file__)"
    # é€šå¸¸åœ¨: site-packages/jittor/compiler.py
    ```

2. **å¤‡ä»½åŸæ–‡ä»¶**ï¼š

    ```bash
    cp compiler.py compiler.py.backup
    ```

3. **ä¿®å¤ä»£ç **ï¼š
   åœ¨ `compiler.py` çš„ `compile` å‡½æ•°ä¸­ï¼Œç¡®ä¿ `link` å˜é‡è¢«æ­£ç¡®åˆå§‹åŒ–ï¼š

    ```python
    def compile(cc_path, cc_flags, files, output_file, return_cmd_only=False):
        # ... å…¶ä»–ä»£ç  ...

        # ç¡®ä¿ link å˜é‡è¢«åˆå§‹åŒ–
        link = ""  # âœ… ä¿®å¤ï¼šåˆå§‹åŒ– link å˜é‡

        if some_condition:
            link = link + f' -Wl,--export-all-symbols,--out-implib,"{afile}" '
    ```

#### æ–¹æ¡ˆå››ï¼šç‰ˆæœ¬é™çº§ï¼ˆå®é™…éªŒè¯æœ‰æ•ˆï¼‰

**æ¨èçš„ç¨³å®šç‰ˆæœ¬**ï¼š

```bash
# å¸è½½å½“å‰é—®é¢˜ç‰ˆæœ¬
pip uninstall jittor

# å®‰è£…ç»è¿‡éªŒè¯çš„ç¨³å®šç‰ˆæœ¬
pip install jittor==1.3.8.5  # æ¨èç‰ˆæœ¬
# æˆ–è€…
pip install jittor==1.3.7.15  # å¤‡é€‰ç¨³å®šç‰ˆæœ¬
```

**ç‰ˆæœ¬é€‰æ‹©è¯´æ˜**ï¼š

-   **é¿å…ä½¿ç”¨**ï¼š1.3.9.x ç³»åˆ—ï¼ˆå­˜åœ¨å·²çŸ¥ Windows ç¼–è¯‘ bugï¼‰
-   **æ¨èä½¿ç”¨**ï¼š1.3.8.x æˆ–æ›´æ—©çš„ç¨³å®šç‰ˆæœ¬
-   **éªŒè¯æ–¹æ³•**ï¼šå®‰è£…åè¿è¡Œç®€å•æµ‹è¯•ç¡®è®¤ç¼–è¯‘æ­£å¸¸

**å®é™…è§£å†³ç»éªŒ**ï¼š
åœ¨å¤šæ¬¡å°è¯•å…¶ä»–æ–¹æ¡ˆå¤±è´¥åï¼Œç‰ˆæœ¬å›é€€åˆ° 1.3.8.5 æˆåŠŸè§£å†³äº†ç¼–è¯‘é—®é¢˜ï¼Œè¿™æ˜¯ç›®å‰æœ€å¯é çš„è§£å†³æ–¹æ¡ˆã€‚

#### æ–¹æ¡ˆäº”ï¼šä½¿ç”¨ PyTorch ç‰ˆæœ¬ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

å¦‚æœ Jittor é—®é¢˜æ— æ³•è§£å†³ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨åŸå§‹çš„ PyTorch ç‰ˆæœ¬ï¼š

```bash
cd ../code  # è¿”å›åŸå§‹ PyTorch ä»£ç ç›®å½•
python inference.py --model_path ../pretrain_models/self_blind_vsr_gaussian.pt --input_dir ../dataset/input/000 --output_dir ../infer_results/pytorch_000
```

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ         | éš¾åº¦ | æˆåŠŸç‡ | æ€§èƒ½ | æ¨èæŒ‡æ•°   | å¤‡æ³¨               |
| ------------ | ---- | ------ | ---- | ---------- | ------------------ |
| Docker       | ä½   | 95%    | ä¸­ç­‰ | â­â­â­â­â­ | æœ€ç¨³å®šï¼Œç¯å¢ƒéš”ç¦»   |
| WSL          | ä¸­   | 90%    | é«˜   | â­â­â­â­   | Linux ç¯å¢ƒï¼Œæ€§èƒ½å¥½ |
| ç‰ˆæœ¬é™çº§     | ä½   | 85%    | é«˜   | â­â­â­â­   | **å®é™…éªŒè¯æœ‰æ•ˆ**   |
| æ‰‹åŠ¨ä¿®å¤     | é«˜   | 70%    | é«˜   | â­â­â­     | éœ€è¦ä¿®æ”¹æ¡†æ¶æºç    |
| PyTorch å¤‡é€‰ | ä½   | 100%   | é«˜   | â­â­â­â­   | ç¨³å®šå¤‡é€‰æ–¹æ¡ˆ       |

### æŠ€æœ¯ç»†èŠ‚

1. **é”™è¯¯ä½ç½®**ï¼š

    - æ–‡ä»¶ï¼š`jittor/compiler.py`
    - è¡Œå·ï¼šç¬¬ 103 è¡Œ
    - å‡½æ•°ï¼š`compile()`

2. **é”™è¯¯å‘ç”Ÿåœºæ™¯**ï¼š

    - ç¼–è¯‘å™¨æ£€æµ‹é˜¶æ®µï¼šJittor å°è¯•æ£€æµ‹å¯ç”¨çš„ç¼–è¯‘å™¨
    - é“¾æ¥å‚æ•°æ„å»ºé˜¶æ®µï¼šä»£ç å°è¯•æ„å»ºé“¾æ¥å™¨å‚æ•°
    - MinGW/g++ ç‰¹æ®Šå¤„ç†ï¼šWindows ä¸‹ä½¿ç”¨ MinGW æ—¶è§¦å‘ç‰¹æ®Šä»£ç è·¯å¾„

3. **ç›¸å…³é—®é¢˜**ï¼š
    - è¿™æ˜¯ Python ä¸­å¸¸è§çš„å˜é‡ä½œç”¨åŸŸé—®é¢˜æ¨¡å¼
    - ç±»ä¼¼é—®é¢˜åœ¨å¤šä¸ªå¼€æºé¡¹ç›®ä¸­å‡ºç°è¿‡

### é¢„é˜²æªæ–½

1. **ç¯å¢ƒé€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨ Linux ç¯å¢ƒæˆ–å®¹å™¨åŒ–éƒ¨ç½²
2. **ç‰ˆæœ¬ç®¡ç†**ï¼šä½¿ç”¨ç»è¿‡æµ‹è¯•çš„ç¨³å®šç‰ˆæœ¬
3. **å¤‡ä»½æœºåˆ¶**ï¼šä¿æŒåŸå§‹ PyTorch ç‰ˆæœ¬ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ

### å®é™…è§£å†³ç»éªŒ

æ ¹æ®å®é™…æµ‹è¯•ï¼Œå„ç§æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§å¦‚ä¸‹ï¼š

1. **ç‰ˆæœ¬å›é€€** âœ… **æœ€ç»ˆæœ‰æ•ˆæ–¹æ¡ˆ**

    - å›é€€åˆ° Jittor 1.3.8.5 ç‰ˆæœ¬æˆåŠŸè§£å†³é—®é¢˜
    - ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–é…ç½®

2. **Docker/WSL** âœ… ç†è®ºå¯è¡Œ

    - ç¯å¢ƒéš”ç¦»ï¼Œä½†éœ€è¦é¢å¤–çš„å®¹å™¨æˆ–å­ç³»ç»Ÿé…ç½®

3. **æ‰‹åŠ¨ä¿®å¤** âŒ å¤æ‚ä¸”ä¸ç¨³å®š
    - ä¿®æ”¹æ¡†æ¶æºç é£é™©è¾ƒé«˜ï¼Œä¸æ¨èæ™®é€šç”¨æˆ·ä½¿ç”¨

### è¯´æ˜

è¿™ä¸ªé”™è¯¯æ˜¯ Jittor 1.3.9.x ç³»åˆ—åœ¨ Windows ç¯å¢ƒä¸‹çš„ä¸¥é‡ bugï¼Œå½±å“æ‰€æœ‰ Windows ç”¨æˆ·ã€‚**å¼ºçƒˆå»ºè®® Windows ç”¨æˆ·é¿å…ä½¿ç”¨ 1.3.9.x ç‰ˆæœ¬ï¼Œæ”¹ç”¨ 1.3.8.5 æˆ–æ›´æ—©çš„ç¨³å®šç‰ˆæœ¬**ã€‚è¿™æ˜¯ç›®å‰æœ€å¯é å’Œæœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚

---

## é€šç”¨ç¯å¢ƒç›¸å…³æç¤º

### ç‰ˆæœ¬å…¼å®¹æ€§é‡è¦æç¤º

**Jittor ç‰ˆæœ¬é€‰æ‹©**ï¼š

-   âœ… **æ¨è**ï¼šJittor 1.3.8.5 åŠä»¥ä¸‹ç‰ˆæœ¬
-   âŒ **é¿å…**ï¼šJittor 1.3.9.x ç³»åˆ—ï¼ˆWindows ä¸‹å­˜åœ¨ä¸¥é‡ç¼–è¯‘ bugï¼‰

**PyTorch ç‰ˆæœ¬å…¼å®¹æ€§**ï¼š

-   âœ… **æ¨è**ï¼šPyTorch 1.12+ æ­é… CuPy 8.0+
-   ğŸ’¡ **æç¤º**ï¼šç¡®ä¿ CUDA ç‰ˆæœ¬ä¸ CuPy ç‰ˆæœ¬åŒ¹é…

### CUDA è·¯å¾„è­¦å‘Š

å¦‚æœçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è­¦å‘Šï¼š

```
WARNING: CUDA path not found, using default path
```

è¿™é€šå¸¸æ˜¯æ­£å¸¸çš„è­¦å‘Šä¿¡æ¯ï¼Œä¸å½±å“å®é™…è¿è¡Œã€‚

### ç¼–è¯‘ä¿¡æ¯

#### Jittor ç‰ˆæœ¬

é¦–æ¬¡è¿è¡Œæ—¶ä¼šçœ‹åˆ°ï¼š

```
Compiling Operators(68/68) used: 29.5s eta: 0s
```

#### PyTorch ç‰ˆæœ¬

é¦–æ¬¡è¿è¡Œæ—¶ä¼šçœ‹åˆ°ï¼š

```
CUDA correlation implementation available
```

---

## æœ€ä½³å®è·µå»ºè®®

### é€šç”¨å»ºè®®

1. **ç¯å¢ƒæ£€æŸ¥**ï¼šè¿è¡Œå‰ç¡®è®¤ GPU ç¯å¢ƒå’Œç›¸å…³åº“å®‰è£…
2. **è·¯å¾„ç¡®è®¤**ï¼šç¡®ä¿æ‰€æœ‰æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼Œé¿å…ä¸­æ–‡è·¯å¾„
3. **æ—¥å¿—è®°å½•**ï¼šä¿æŒè¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•
4. **å¼‚å¸¸å¤„ç†**ï¼šæ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### PyTorch ç‰ˆæœ¬ç‰¹å®šå»ºè®®

1. **ç¯å¢ƒå˜é‡è®¾ç½®**ï¼šæå‰è®¾ç½® TEMP å’Œ TMP ç¯å¢ƒå˜é‡
2. **æ¨¡å‹é¢„çƒ­**ï¼šé¦–æ¬¡æ¨ç†å‰è¿›è¡Œæ¨¡å‹é¢„çƒ­
3. **CUDA ç¯å¢ƒ**ï¼šç¡®ä¿ CUDA å·¥å…·é“¾æ­£ç¡®å®‰è£…

### Jittor ç‰ˆæœ¬ç‰¹å®šå»ºè®®

1. **API é€‚é…**ï¼šæ³¨æ„ PyTorch åˆ° Jittor çš„ API å·®å¼‚
2. **GPU è®¾ç½®**ï¼šæ˜ç¡®è®¾ç½® GPU ä½¿ç”¨æ ‡å¿—
3. **ç¼–è¯‘ç¼“å­˜**ï¼šé¦–æ¬¡è¿è¡Œç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œåç»­ä¼šæ›´å¿«

---

## æ€»ç»“

é€šè¿‡è§£å†³ä»¥ä¸Šé—®é¢˜ï¼ŒSelf-Blind-VSR çš„ä¸¤ä¸ªç‰ˆæœ¬éƒ½å·²èƒ½æ­£å¸¸è¿è¡Œï¼š

### PyTorch ç‰ˆæœ¬ä¸»è¦å·¥ä½œ

-   **ç¯å¢ƒé…ç½®**ï¼šè§£å†³ä¸­æ–‡è·¯å¾„å¯¼è‡´çš„ CUDA ç¼–è¯‘é—®é¢˜
-   **ä¾èµ–ç®¡ç†**ï¼šç¡®ä¿ CuPy å’Œ CUDA ç¯å¢ƒæ­£ç¡®é…ç½®
-   **æ€§èƒ½ä¼˜åŒ–**ï¼šæˆåŠŸå¯ç”¨ CUDA åŠ é€Ÿçš„ correlation å®ç°

### Jittor ç‰ˆæœ¬ä¸»è¦å·¥ä½œ

-   **API é€‚é…**ï¼šå®Œæˆ PyTorch åˆ° Jittor çš„ API ç§»æ¤
-   **è·¯å¾„å’Œå¯¼å…¥ä¿®å¤**ï¼šè§£å†³æ¨¡å—å¯¼å…¥å’Œæ–‡ä»¶è·¯å¾„é—®é¢˜
-   **GPU è®¾ç½®ä¼˜åŒ–**ï¼šä¼˜åŒ– GPU ä½¿ç”¨é…ç½®
-   **å¼‚å¸¸å¤„ç†å®Œå–„**ï¼šå¢å¼ºä»£ç ç¨³å®šæ€§
-   **Windows ç¼–è¯‘é—®é¢˜**ï¼šé€šè¿‡ç‰ˆæœ¬å›é€€è§£å†³ Jittor 1.3.9.x çš„ç¼–è¯‘å™¨ bug

æœ€ç»ˆä¸¤ä¸ªç‰ˆæœ¬éƒ½å®ç°äº†å®Œæ•´çš„è§†é¢‘è¶…åˆ†è¾¨ç‡æ¨ç†åŠŸèƒ½ï¼Œæ”¯æŒ GPU åŠ é€Ÿå’Œè¯¦ç»†çš„æ—¥å¿—è¾“å‡ºã€‚

---

## 11. GPU å†…å­˜æº¢å‡ºå’Œ API å…¼å®¹æ€§é—®é¢˜

### é—®é¢˜æè¿°

åœ¨ Jittor ç‰ˆæœ¬è®­ç»ƒæ—¶é‡åˆ°ä¸¤ä¸ªå…³é”®é”™è¯¯ï¼š

1. **GPU å†…å­˜æº¢å‡ºé”™è¯¯**ï¼š

```
GPU memory is overflow, please reduce your batch_size or data size!
Total: 4GB Used: 8.386GB
```

2. **API å…¼å®¹æ€§é”™è¯¯**ï¼š

```
âŒ è®­ç»ƒå‡ºé”™: Wrong inputs arguments, Please refer to examples(help(jt.item)).
Types of your inputs are:
 self   = Var,
 args   = (),

The function declarations are:
 ItemData item()
```

### é”™è¯¯åŸå› 

1. **å†…å­˜æº¢å‡ºé—®é¢˜**ï¼š

    - é»˜è®¤ batch_size = 8 å¯¹äº 4GB æ˜¾å­˜çš„ GPU è¿‡å¤§
    - å®é™…å†…å­˜ä½¿ç”¨é‡è¾¾åˆ° 8.386GBï¼Œè¶…å‡ºç¡¬ä»¶é™åˆ¶

2. **API å…¼å®¹æ€§é—®é¢˜**ï¼š
    - Jittor ä¸­çš„ `.item()` æ–¹æ³•ä¸ PyTorch è¯­æ³•ä¸åŒ
    - Jittor ä½¿ç”¨ `.data[0]` è·å–æ ‡é‡å€¼ï¼Œè€Œä¸æ˜¯ `.item()`

### è§£å†³æ–¹æ¡ˆ

#### 1. ä¿®å¤ API å…¼å®¹æ€§é—®é¢˜

**åœ¨ `loss/__init__.py` ä¸­ä¿®æ”¹**ï¼š

```python
# åŸä»£ç ï¼ˆPyTorch é£æ ¼ï¼‰
self.log[-1, i] += effective_loss.item()
self.log[-1, -1] += loss_sum.item()

# ä¿®æ”¹ä¸ºï¼ˆJittor é£æ ¼ï¼‰
self.log[-1, i] += effective_loss.data[0]
self.log[-1, -1] += loss_sum.data[0]
```

**åœ¨ `trainer/trainer_flow_video.py` ä¸­ä¿®æ”¹**ï¼š

```python
# åŸä»£ç ï¼ˆPyTorch é£æ ¼ï¼‰
cycle_loss_sum = cycle_loss_sum + cycle_loss.item()
kloss_boundaries_sum = kloss_boundaries_sum + kloss_boundaries.item()
kloss_sparse_sum = kloss_sparse_sum + kloss_sparse.item()
kloss_center_sum = kloss_center_sum + kloss_center.item()
mid_loss_sum = mid_loss_sum + mid_loss.item()
self.ckp.report_log(loss.item())
'loss': f'{loss.item():.3f}',
'cycle': f'{cycle_loss.item():.3f}'

# ä¿®æ”¹ä¸ºï¼ˆJittor é£æ ¼ï¼‰
cycle_loss_sum = cycle_loss_sum + cycle_loss.data[0]
kloss_boundaries_sum = kloss_boundaries_sum + kloss_boundaries.data[0]
kloss_sparse_sum = kloss_sparse_sum + kloss_sparse.data[0]
kloss_center_sum = kloss_center_sum + kloss_center.data[0]
mid_loss_sum = mid_loss_sum + mid_loss.data[0]
self.ckp.report_log(loss.data[0])
'loss': f'{loss.data[0]:.3f}',
'cycle': f'{cycle_loss.data[0]:.3f}'
```

#### 2. é™ä½ batch_size é€‚åº” GPU å†…å­˜

**åœ¨ `option/template.py` ä¸­ä¿®æ”¹**ï¼š

```python
# åŸé…ç½®
args.batch_size = 8

# ä¿®æ”¹ä¸ºé€‚åº” 4GB æ˜¾å­˜
args.batch_size = 2
```

**é’ˆå¯¹ä¸åŒ GPU æ˜¾å­˜çš„å»ºè®®é…ç½®**ï¼š

| GPU æ˜¾å­˜ | æ¨è batch_size | å†…å­˜ä½¿ç”¨ç‡ | è®­ç»ƒç¨³å®šæ€§ |
| -------- | --------------- | ---------- | ---------- |
| 4GB      | 1-2             | ~75%       | ç¨³å®š       |
| 6GB      | 2-4             | ~80%       | ç¨³å®š       |
| 8GB      | 4-6             | ~85%       | ç¨³å®š       |
| 12GB+    | 6-8             | ~75%       | æœ€ä½³       |

### æŠ€æœ¯ç»†èŠ‚

#### API å·®å¼‚å¯¹æ¯”

| æ“ä½œç±»å‹   | PyTorch è¯­æ³•        | Jittor è¯­æ³•                | è¯´æ˜                            |
| ---------- | ------------------- | -------------------------- | ------------------------------- |
| è·å–æ ‡é‡å€¼ | `tensor.item()`     | `var.data[0]`              | ä» 0 ç»´ tensor è·å– Python æ ‡é‡ |
| æ— æ¢¯åº¦è®¡ç®— | `torch.no_grad()`   | `jt.no_grad()`             | ä¸Šä¸‹æ–‡ç®¡ç†å™¨                    |
| åå‘ä¼ æ’­   | `loss.backward()`   | `optimizer.backward(loss)` | æ¢¯åº¦è®¡ç®—æ–¹å¼                    |
| è®¾å¤‡è½¬æ¢   | `tensor.to(device)` | è‡ªåŠ¨å¤„ç†                   | Jittor è‡ªåŠ¨è®¾å¤‡ç®¡ç†             |

#### å†…å­˜ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹æ¬¡å¤§å°è°ƒæ•´**ï¼š

    - åŸåˆ™ï¼šæ˜¾å­˜ä½¿ç”¨ç‡ä¿æŒåœ¨ 80% ä»¥ä¸‹
    - æ–¹æ³•ï¼šé€æ­¥å‡å° batch_size ç›´åˆ°ç¨³å®šè¿è¡Œ

2. **æ¢¯åº¦ç´¯ç§¯**ï¼ˆå¯é€‰ï¼‰ï¼š

    ```python
    # å¦‚æœéœ€è¦ä¿æŒç­‰æ•ˆçš„æ‰¹æ¬¡å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯
    accumulation_steps = 4  # 8 / 2 = 4
    for i, batch in enumerate(dataloader):
        loss = model(batch) / accumulation_steps
        optimizer.backward(loss)
        if (i + 1) % accumulation_steps == 0:
            optimizer.step()
            optimizer.zero_grad()
    ```

3. **æ•°æ®é¢„å¤„ç†ä¼˜åŒ–**ï¼š
    - å‡å°‘é¢„åŠ è½½æ•°æ®é‡
    - ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç±»å‹ï¼ˆå¦‚ float16ï¼‰

### è§£å†³éªŒè¯

æˆåŠŸè§£å†³åä¼šçœ‹åˆ°ï¼š

```
====================================
å¼€å§‹è®­ç»ƒ Epoch 1
====================================
è®­ç»ƒé›†å¤§å°: 32144æ ·æœ¬, 16072æ‰¹æ¬¡
è®­ç»ƒ(Epoch 1) |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16072/16072 [45:30<00:00, 5.88it/s] PSNR=25.32 loss=0.045 cycle=0.012
```

è€Œä¸æ˜¯å†…å­˜æº¢å‡ºé”™è¯¯ã€‚

### æ€§èƒ½å½±å“

**batch_size å‡å°çš„å½±å“**ï¼š

1. **è®­ç»ƒé€Ÿåº¦**ï¼š

    - batch_size=8: ~4018 æ‰¹æ¬¡/epoch
    - batch_size=2: ~16072 æ‰¹æ¬¡/epoch
    - æ€»è®­ç»ƒæ—¶é—´å¢åŠ ï¼Œä½†å•æ‰¹æ¬¡æ›´å¿«

2. **æ”¶æ•›æ€§**ï¼š

    - æ›´å°çš„æ‰¹æ¬¡æä¾›æ›´é¢‘ç¹çš„æ¢¯åº¦æ›´æ–°
    - å¯èƒ½éœ€è¦è°ƒæ•´å­¦ä¹ ç‡ï¼ˆé€šå¸¸æŒ‰æ¯”ä¾‹å‡å°ï¼‰

3. **å†…å­˜æ•ˆç‡**ï¼š
    - æ˜¾å­˜ä½¿ç”¨ç‡ä» >100% é™åˆ° ~75%
    - æ›´ç¨³å®šçš„è®­ç»ƒè¿‡ç¨‹

### é¢„é˜²æªæ–½

1. **GPU å†…å­˜ç›‘æ§**ï¼š

    ```bash
    # å®æ—¶ç›‘æ§ GPU å†…å­˜ä½¿ç”¨
    nvidia-smi -l 1
    ```

2. **ä»£ç æµ‹è¯•**ï¼š

    ```python
    # åœ¨è®­ç»ƒå‰æµ‹è¯• API å…¼å®¹æ€§
    import jittor as jt
    x = jt.array([1.0])
    print(x.data[0])  # æ­£ç¡®ï¼šä½¿ç”¨ .data[0]
    # print(x.item())  # é”™è¯¯ï¼šJittor ä¸­è¯­æ³•ä¸åŒ
    ```

3. **æ¸è¿›å¼è°ƒè¯•**ï¼š
    - å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•
    - é€æ­¥å¢åŠ  batch_size
    - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### å®é™…è§£å†³ç»éªŒ

åœ¨æœ¬æ¬¡è§£å†³è¿‡ç¨‹ä¸­ï¼š

1. **é—®é¢˜è¯Šæ–­é¡ºåº**ï¼š

    - é¦–å…ˆè¯†åˆ«å†…å­˜æº¢å‡ºé—®é¢˜
    - ç„¶åå‘ç° API å…¼å®¹æ€§é—®é¢˜
    - åŒæ—¶è¿›è¡Œä¸¤ä¸ªé—®é¢˜çš„ä¿®å¤

2. **ä¿®å¤ç­–ç•¥**ï¼š

    - API é—®é¢˜ï¼šç³»ç»Ÿæ€§æ›¿æ¢æ‰€æœ‰ `.item()` è°ƒç”¨
    - å†…å­˜é—®é¢˜ï¼šæ ¹æ®ç¡¬ä»¶é™åˆ¶è°ƒæ•´ batch_size

3. **éªŒè¯æ–¹æ³•**ï¼š
    - å•ç‹¬æµ‹è¯•æ¯ä¸ªä¿®å¤
    - å®Œæ•´è¿è¡Œè®­ç»ƒæµç¨‹éªŒè¯
